<html>

<!--
<script src="libs\jquery.js" type="text/javascript"></script>
<script src="libs\three.js" type="text/javascript"></script>-->
<script src ="libs\gl-matrix.js" type ="text/javascript"></script>
<script src="libs\webgl-utils.js" type="text/javascript"></script>

<head>
<title>Water Shader</title>
<meta charset ="utf-8">
<meta http-equiv="X-UA-Compatible" content="chrome=1">  <!-- Use Chrome Frame in IE -->

  <script id="vs_copy" type="x-shader/x-vertex">
  attribute vec2 position;
  varying vec2 f_Pos;
  void main(void)
  {
        f_Pos = position.xy;
		gl_Position= vec4(position*2.0-vec2(1.0),0,1.0);
  }
</script>
<script id="fs_copy" type="x-shader/x-fragment">
   precision mediump float;
   varying vec2 f_Pos;
   uniform sampler2D uSampler;
   uniform float u_time;

  void main(void)
  {
    vec3 color=texture2D(uSampler,f_Pos).xyz;
	gl_FragColor = vec4(color,1.0);
  }
</script>
<script id="vs_sim" type="x-shader/x-vertex">
    precision mediump float;
    attribute vec2 position;
    varying vec2 f_Pos;
  void main(void)
  {

        f_Pos = position;
		gl_Position= vec4(position,0,1.0);
  }
</script>
<script id="fs_sim" type="x-shader/x-fragment">
   precision mediump float;
    uniform sampler2D uSampler;
    uniform float u_time;
    varying vec2 f_Pos;

  float isValid(vec2 texcoord)
  {
    if(texcoord.x<0.0) return 0.0;
    if(texcoord.y<0.0) return 0.0;
    if(texcoord.x>1.0) return 0.0;
    if(texcoord.y>1.0) return 0.0;
    return 1.0;
  }
  vec2 adjustTexcoord(vec2 texcoord)
  {
    vec2 result = texcoord;
    if(result.x<0.0) result.x=0.0;
    if(result.y<0.0) result.y=0.0;
    if(result.x>1.0) result.x=1.0;
    if(result.y>1.0) result.y=1.0;
    return result;
  }
  float getAverage(sampler2D samp, vec2 texcoord)
  {
    int count = 0;
    float delta=1.0/256.0;
    vec2 upcoord = adjustTexcoord(texcoord + vec2(0,delta));
    vec2 downcoord =adjustTexcoord( texcoord - vec2(0,delta));
    vec2 leftcoord = adjustTexcoord(texcoord + vec2(delta,0));
    vec2 rightcoord =adjustTexcoord( texcoord - vec2(delta,0));
    float totalz=0.0;
    if(isValid(upcoord)>0.5)
    { count+=1; totalz+=texture2D(samp,upcoord).z;}
    if(isValid(downcoord)>0.5)
    { count+=1; totalz+=texture2D(samp,downcoord).z;}
    if(isValid(leftcoord)>0.5)
    { count+=1; totalz+=texture2D(samp,leftcoord).z;}
    if(isValid(rightcoord)>0.5)
    { count+=1; totalz+=texture2D(samp,rightcoord).z;}
    if(count==0) return 0.0;
    return totalz/float(count);
  }
  void main(void)
  {

    vec2 texcoord = (f_Pos+vec2(1.0))*0.5;


    float height=0.0;
    float heightaround=0.0;
    float vel=0.0;
    if(u_time<0.015)
    {
        height = (1.0-length(f_Pos))*1.01;
    }
    else{
        vec2 vel_h=texture2D(uSampler, texcoord).yz;
        height=vel_h.y;
        heightaround =getAverage(uSampler, texcoord);
         vel = vel_h.x;
        vel += (heightaround-height)*0.99;
        height = height+vel;
    }
	gl_FragColor = vec4(0,vel,height,1.0);
  }
</script>
<script id="vs_render" type="x-shader/x-vertex">
precision mediump float;

  attribute vec3 position;
  attribute vec3 normal;

  uniform mat4 u_modelViewPerspective;
  uniform sampler2D uSampler;
  uniform float u_time;
  varying vec2 heightfieldtexcoord;
  varying float height;
  varying vec3 thenormal;

  void main(void)
  {

		vec2 offsetpos=position.xy*2.0-vec2(1.0);
        heightfieldtexcoord=position.xy;
        float h = texture2D(uSampler,heightfieldtexcoord).z;

        h=position.z;
        gl_Position = u_modelViewPerspective * vec4(vec3(position.xy, h), 1.0);
        //gl_Position = u_modelViewPerspective * vec4(position, 1.0);
        height = h;
        thenormal=normal;
  }
</script>
<script id="fs_render" type="x-shader/x-fragment">
    precision mediump float;

	varying vec2 heightfieldtexcoord;

    uniform sampler2D uSampler;
    uniform float u_time;
    varying float height;
    varying vec3 thenormal;

  void main(void)
  {
  	vec3 outcolor=vec3(1.0);

  //	outcolor=vec3(0,0,1)*texture2D(uSampler, heightfieldtexcoord).z;

  	outcolor=vec3(0,0,1)*height;
  	outcolor=vec3(0,0,1);
  	float diffuse = max(0.0,-dot(normalize(thenormal),normalize(vec3(0,-1.0,-1.0))));
    gl_FragColor = vec4(outcolor*diffuse, 1.0);
    //gl_FragColor = vec4(thenormal,1.0);
  }
</script>

<script src="water_mesh.js" type="text/javascript"></script>
</head>

<body onload="webGLStart();">

<p style="font-size:30px">This is WebGL water shader</p>
<div id="message" style="position:absolute;top:100px"></div> <!-- Pixel offset to avoid FPS counter -->
<div id = "debug_text"></div>
<canvas id="canvas1" style="border: none;" width="1024" height="1024" tabindex="1"></canvas>

</body>

</html>
